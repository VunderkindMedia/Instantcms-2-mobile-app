var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=useNavigationBuilder;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var React=_interopRequireWildcard(require("react"));var _NavigationContainer=require("./NavigationContainer");var _NavigationRouteContext=_interopRequireDefault(require("./NavigationRouteContext"));var _Screen=_interopRequireDefault(require("./Screen"));var _CommonActions=require("./CommonActions");var _useEventEmitter=_interopRequireDefault(require("./useEventEmitter"));var _useRegisterNavigator=_interopRequireDefault(require("./useRegisterNavigator"));var _useDescriptors=_interopRequireDefault(require("./useDescriptors"));var _useNavigationHelpers=_interopRequireDefault(require("./useNavigationHelpers"));var _useOnAction=_interopRequireDefault(require("./useOnAction"));var _useFocusEvents=_interopRequireDefault(require("./useFocusEvents"));var _useOnRouteFocus=_interopRequireDefault(require("./useOnRouteFocus"));var _useChildActionListeners=_interopRequireDefault(require("./useChildActionListeners"));var _useFocusedListeners2=_interopRequireDefault(require("./useFocusedListeners"));var _useFocusedListenersChildrenAdapter=_interopRequireDefault(require("./useFocusedListenersChildrenAdapter"));var _types=require("./types");var _useStateGetters2=_interopRequireDefault(require("./useStateGetters"));var _useOnGetState=_interopRequireDefault(require("./useOnGetState"));function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2.default)(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}_types.PrivateValueStore;var isArrayEqual=function isArrayEqual(a,b){return a.length===b.length&&a.every(function(it,index){return it===b[index];});};var getRouteConfigsFromChildren=function getRouteConfigsFromChildren(children){return React.Children.toArray(children).reduce(function(acc,child){if(React.isValidElement(child)){if(child.type===_Screen.default){acc.push(child.props);return acc;}if(child.type===React.Fragment){acc.push.apply(acc,(0,_toConsumableArray2.default)(getRouteConfigsFromChildren(child.props.children)));return acc;}}throw new Error("A navigator can only contain 'Screen' components as its direct children (found '"+(child.type&&child.type.name?child.type.name:String(child))+"')");},[]);};function useNavigationBuilder(createRouter,options){(0,_useRegisterNavigator.default)();var route=React.useContext(_NavigationRouteContext.default);var previousRouteRef=React.useRef(route);React.useEffect(function(){previousRouteRef.current=route;},[route]);var children=options.children,rest=(0,_objectWithoutProperties2.default)(options,["children"]);var _React$useRef=React.useRef(createRouter(_objectSpread({},rest,{},(route==null?void 0:route.params)&&typeof route.params.screen==='string'?{initialRouteName:route.params.screen}:null))),router=_React$useRef.current;var screens=getRouteConfigsFromChildren(children).reduce(function(acc,curr){if(curr.name in acc){throw new Error("A navigator cannot contain multiple 'Screen' components with the same name (found duplicate screen named '"+curr.name+"')");}acc[curr.name]=curr;return acc;},{});var routeNames=Object.keys(screens);var routeParamList=routeNames.reduce(function(acc,curr){var initialParams=screens[curr].initialParams;var initialParamsFromParams=(route==null?void 0:route.params)&&route.params.screen===curr?route.params.params:undefined;acc[curr]=initialParams!==undefined||initialParamsFromParams!==undefined?_objectSpread({},initialParams,{},initialParamsFromParams):undefined;return acc;},{});if(!routeNames.length){throw new Error("Couldn't find any screens for the navigator. Have you defined any screens as its children?");}var isStateValid=React.useCallback(function(state){return state.type===undefined||state.type===router.type;},[router.type]);var isStateInitialized=React.useCallback(function(state){return state!==undefined&&state.stale===false&&isStateValid(state);},[isStateValid]);var _React$useContext=React.useContext(_NavigationContainer.NavigationStateContext),currentState=_React$useContext.state,getCurrentState=_React$useContext.getState,setState=_React$useContext.setState,key=_React$useContext.key,performTransaction=_React$useContext.performTransaction;var previousStateRef=React.useRef();var initializedStateRef=React.useRef();if(initializedStateRef.current===undefined||currentState!==previousStateRef.current){initializedStateRef.current=currentState===undefined||!isStateValid(currentState)?router.getInitialState({routeNames:routeNames,routeParamList:routeParamList}):router.getRehydratedState(currentState,{routeNames:routeNames,routeParamList:routeParamList});}React.useEffect(function(){previousStateRef.current=currentState;},[currentState]);var state=isStateInitialized(currentState)?currentState:initializedStateRef.current;var nextState=state;if(!isArrayEqual(state.routeNames,routeNames)){nextState=router.getStateForRouteNamesChange(state,{routeNames:routeNames,routeParamList:routeParamList});}if(previousRouteRef.current&&route&&route.params&&typeof route.params.screen==='string'&&route.params!==previousRouteRef.current.params){var updatedState=router.getStateForAction(state,(0,_CommonActions.navigate)(route.params.screen,route.params.params),{routeNames:routeNames,routeParamList:routeParamList});nextState=updatedState!==null?router.getRehydratedState(updatedState,{routeNames:routeNames,routeParamList:routeParamList}):state;}if(state!==nextState){performTransaction(function(){setState(nextState);});}state=nextState;React.useEffect(function(){return function(){performTransaction(function(){return getCurrentState()!==undefined&&setState(undefined);});};},[]);var getState=React.useCallback(function(){var currentState=getCurrentState();return isStateInitialized(currentState)?currentState:initializedStateRef.current;},[getCurrentState,isStateInitialized]);var emitter=(0,_useEventEmitter.default)();(0,_useFocusEvents.default)({state:state,emitter:emitter});React.useEffect(function(){emitter.emit({type:'state',data:{state:state}});},[emitter,state]);var _useChildActionListen=(0,_useChildActionListeners.default)(),actionListeners=_useChildActionListen.listeners,addActionListener=_useChildActionListen.addListener;var _useFocusedListeners=(0,_useFocusedListeners2.default)(),focusedListeners=_useFocusedListeners.listeners,addFocusedListener=_useFocusedListeners.addListener;var _useStateGetters=(0,_useStateGetters2.default)(),getStateForRoute=_useStateGetters.getStateForRoute,addStateGetter=_useStateGetters.addStateGetter;var onAction=(0,_useOnAction.default)({router:router,getState:getState,setState:setState,key:key,listeners:actionListeners,routerConfigOptions:{routeNames:routeNames,routeParamList:routeParamList}});var onRouteFocus=(0,_useOnRouteFocus.default)({router:router,key:key,getState:getState,setState:setState});var navigation=(0,_useNavigationHelpers.default)({onAction:onAction,getState:getState,emitter:emitter,router:router});(0,_useFocusedListenersChildrenAdapter.default)({navigation:navigation,focusedListeners:focusedListeners});(0,_useOnGetState.default)({getState:getState,getStateForRoute:getStateForRoute});var descriptors=(0,_useDescriptors.default)({state:state,screens:screens,navigation:navigation,screenOptions:options.screenOptions,onAction:onAction,getState:getState,setState:setState,onRouteFocus:onRouteFocus,addActionListener:addActionListener,addFocusedListener:addFocusedListener,addStateGetter:addStateGetter,router:router,emitter:emitter});return{state:state,navigation:navigation,descriptors:descriptors};}
//# sourceMappingURL=useNavigationBuilder.js.map